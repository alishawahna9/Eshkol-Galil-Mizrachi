
import React, { useEffect, useRef } from 'react';
import { MapContainer, TileLayer, Marker, Popup, useMap } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';
import L from 'leaflet';

export const styles = {
  container: "bg-gray-100 dark:bg-[#0F1F38] rounded-xl overflow-hidden h-full min-h-[600px] relative border-2 border-gray-300 dark:border-gray-700",
  mapContainer: { height: '100%', width: '100%' },
  popup: "text-center",
  popupTitle: "text-lg block mb-1",
  popupText: "text-sm text-gray-600"
};

export const markerStyles = {
  backgroundColor: (color) => color, // This will be dynamic based on population color
  width: '25px',
  height: '25px',
  borderRadius: '50% 50% 50% 0',
  transform: 'rotate(-45deg)',
  border: '3px solid white',
  boxShadow: '0 2px 5px rgba(0,0,0,0.3)'
};

export const populationColors = {
  high: '#1B4C8C',      // > 30000
  veryHigh: '#22A7D6',  // > 20000
  high2: '#6FD1F5',     // > 15000
  medium: '#8CD43A',    // > 10000
  medium2: '#BED43A',   // > 7000
  low: '#E8D43A',       // > 5000
  veryLow: '#F5B041',   // > 3000
  minimal: '#F8C471'    // default
};

// Helper function to get color based on population
const getColorByPopulation = (value) => {
  const pop = parseInt(value.replace(/,/g, ''));
  if (pop > 30000) return populationColors.high; 
  if (pop > 20000) return populationColors.veryHigh;
  if (pop > 15000) return populationColors.high2;
  if (pop > 10000) return populationColors.medium;
  if (pop > 7000) return populationColors.medium2;
  if (pop > 5000) return populationColors.low;
  if (pop > 3000) return populationColors.veryLow;
  return populationColors.minimal;
};

// Create custom colored marker icon
const createColoredIcon = (color) => {
  return L.divIcon({
    className: 'custom-marker',
    html: `<div style="
      background-color: ${color};
      width: ${markerStyles.width};
      height: ${markerStyles.height};
      border-radius: ${markerStyles.borderRadius};
      transform: ${markerStyles.transform};
      border: ${markerStyles.border};
      box-shadow: ${markerStyles.boxShadow};
    "></div>`,
    iconSize: [parseInt(markerStyles.width), parseInt(markerStyles.height)], // Use values from markerStyles
    iconAnchor: [parseInt(markerStyles.width) / 2, parseInt(markerStyles.height) - 1], // Center horizontally, anchor at bottom-ish
  });
};

// Historical municipality data (2002-2023)
const municipalityData = [
  {"רשות":"בוקעתא","2002":5100,"2003":5200,"2004":5300,"2005":5400,"2006":5600,"2007":5700,"2008":5800,"2009":5800,"2010":5900,"2011":6000,"2012":6100,"2013":6200,"2014":6200,"2015":6300,"2016":6400,"2017":6500,"2018":6528,"2019":6610,"2020":6665,"2021":6752,"2022":6805,"2023":6835},
  {"רשות":"גולן","2002":10000,"2003":10300,"2004":10600,"2005":11000,"2006":11500,"2007":11900,"2008":12200,"2009":12200,"2010":12600,"2011":13200,"2012":13800,"2013":14000,"2014":15100,"2015":15600,"2016":16500,"2017":17000,"2018":17538,"2019":17982,"2020":18516,"2021":19214,"2022":20003,"2023":21484},
  {"רשות":"גוש חלב (גיש)","2002":2600,"2003":2600,"2004":2600,"2005":2700,"2006":2700,"2007":2700,"2008":2700,"2009":2900,"2010":3000,"2011":3000,"2012":3000,"2013":3000,"2014":3000,"2015":3100,"2016":3100,"2017":3100,"2018":3090,"2019":3105,"2020":3127,"2021":3154,"2022":3216,"2023":3233},
  {"רשות":"הגליל העליון","2002":12400,"2003":12300,"2004":12200,"2005":12200,"2006":12400,"2007":12700,"2008":13000,"2009":15100,"2010":15400,"2011":16100,"2012":16400,"2013":16900,"2014":17000,"2015":17300,"2016":17400,"2017":17800,"2018":18246,"2019":18610,"2020":19042,"2021":19440,"2022":19922,"2023":20881},
  {"רשות":"חצור הגלילית","2002":8500,"2003":8500,"2004":8400,"2005":8400,"2006":8400,"2007":8600,"2008":8700,"2009":8500,"2010":8700,"2011":8700,"2012":8800,"2013":8900,"2014":8800,"2015":8800,"2016":9000,"2017":9100,"2018":9165,"2019":9272,"2020":9569,"2021":9764,"2022":10047,"2023":11061},
  {"רשות":"טובא - זנגריה","2002":4800,"2003":4900,"2004":5000,"2005":5200,"2006":5300,"2007":5400,"2008":5500,"2009":5600,"2010":5700,"2011":5900,"2012":5900,"2013":6000,"2014":6100,"2015":6300,"2016":6400,"2017":6500,"2018":6667,"2019":6776,"2020":6896,"2021":7011,"2022":7095,"2023":7109},
  {"רשות":"יסוד המעלה","2002":1200,"2003":1200,"2004":1200,"2005":1300,"2006":1300,"2007":1300,"2008":1400,"2009":1400,"2010":1500,"2011":1500,"2012":1600,"2013":1600,"2014":1700,"2015":1600,"2016":1700,"2017":1700,"2018":1719,"2019":1730,"2020":1761,"2021":1804,"2022":1798,"2023":1965},
  {"רשות":"מבואות החרמון","2002":5500,"2003":5600,"2004":5800,"2005":5900,"2006":6000,"2007":6100,"2008":6200,"2009":6200,"2010":6300,"2011":6400,"2012":6600,"2013":6700,"2014":6800,"2015":7000,"2016":7200,"2017":7200,"2018":7242,"2019":7351,"2020":7478,"2021":7564,"2022":7728,"2023":8827},
  {"רשות":"מגדל שמס","2002":8200,"2003":8400,"2004":8600,"2005":8800,"2006":8900,"2007":9200,"2008":9300,"2009":9600,"2010":9800,"2011":9100,"2012":10200,"2013":10300,"2014":10500,"2015":10600,"2016":10800,"2017":10900,"2018":11045,"2019":11180,"2020":11267,"2021":11405,"2022":11458,"2023":11235},
  {"רשות":"מטולה","2002":1500,"2003":1500,"2004":1500,"2005":1500,"2006":1500,"2007":1500,"2008":1500,"2009":1500,"2010":1600,"2011":1600,"2012":1600,"2013":1600,"2014":1600,"2015":1600,"2016":1600,"2017":1600,"2018":1599,"2019":1615,"2020":1654,"2021":1693,"2022":1740,"2023":2152},
  {"רשות":"מסעדה","2002":3000,"2003":3100,"2004":3200,"2005":3300,"2006":3300,"2007":3400,"2008":3500,"2009":3100,"2010":3100,"2011":3300,"2012":3300,"2013":3400,"2014":3400,"2015":3500,"2016":3600,"2017":3600,"2018":3650,"2019":3714,"2020":3753,"2021":3812,"2022":3869,"2023":4161},
  {"רשות":"מרום הגליל","2002":10600,"2003":10600,"2004":11000,"2005":11200,"2006":11400,"2007":11600,"2008":11900,"2009":13100,"2010":13100,"2011":14000,"2012":13800,"2013":14100,"2014":14600,"2015":14900,"2016":15100,"2017":15400,"2018":15346,"2019":15524,"2020":15764,"2021":15892,"2022":16205,"2023":16846},
  {"רשות":"ע'ג'ר","2002":1800,"2003":1900,"2004":2000,"2005":2100,"2006":2200,"2007":2100,"2008":2200,"2009":2200,"2010":2200,"2011":2300,"2012":2300,"2013":2400,"2014":2400,"2015":2500,"2016":2500,"2017":2600,"2018":2607,"2019":2659,"2020":2702,"2021":2745,"2022":2806,"2023":2699},
  {"רשות":"עין קנייא","2002":1700,"2003":1800,"2004":1800,"2005":1900,"2006":1900,"2007":1900,"2008":1900,"2009":1700,"2010":1800,"2011":1800,"2012":1900,"2013":1900,"2014":1900,"2015":1900,"2016":2000,"2017":2063,"2018":2098,"2019":2139,"2020":2172,"2021":2190,"2022":2438,"2023":2438},
  {"רשות":"צפת","2002":26400,"2003":26800,"2004":27300,"2005":28200,"2006":28800,"2007":28500,"2008":28600,"2009":29600,"2010":30900,"2011":32200,"2012":32900,"2013":32100,"2014":32300,"2015":33600,"2016":35300,"2017":36700,"2018":36800,"2019":36061,"2020":37472,"2021":38029,"2022":39179,"2023":39179},
  {"רשות":"קצרין","2002":6300,"2003":6300,"2004":6400,"2005":6500,"2006":6500,"2007":6400,"2008":6500,"2009":6500,"2010":6700,"2011":6700,"2012":6700,"2013":6700,"2014":6800,"2015":6900,"2016":7000,"2017":7100,"2018":7131,"2019":7297,"2020":7500,"2021":7606,"2022":7879,"2023":8043},
  {"רשות":"קרית שמונה","2002":22000,"2003":22000,"2004":22000,"2005":22200,"2006":23000,"2007":23100,"2008":23300,"2009":23000,"2010":23000,"2011":23100,"2012":23100,"2013":23100,"2014":22900,"2015":22624,"2016":22512,"2017":22363,"2018":22636,"2019":22624,"2020":22512,"2021":22336,"2022":22492,"2023":24254},
  {"רשות":"ראש פינה","2002":2200,"2003":2300,"2004":2400,"2005":2500,"2006":2500,"2007":2500,"2008":2700,"2009":2700,"2010":2700,"2011":2800,"2012":2800,"2013":2900,"2014":2900,"2015":3000,"2016":3000,"2017":3120,"2018":3148,"2019":3217,"2020":3237,"2021":3308,"2022":3376,"2023":3376}
];

// Municipality locations in Eastern Galilee with position data
const municipalities = [
  { name: 'צפת', position: [32.9658, 35.4983] },
  { name: 'קרית שמונה', position: [33.2074, 35.5697] },
  { name: 'גולן', position: [32.9000, 35.7500] },
  { name: 'הגליל העליון', position: [33.0500, 35.4500] },
  { name: 'מרום הגליל', position: [33.0228, 35.4431] },
  { name: 'מגדל שמס', position: [33.2700, 35.7700] },
  { name: 'חצור הגלילית', position: [32.9683, 35.5383] },
  { name: 'מבואות החרמון', position: [33.2500, 35.7700] },
  { name: 'קצרין', position: [32.9930, 35.6960] },
  { name: 'טובא - זנגריה', position: [32.8308, 35.3092] },
  { name: 'בוקעתא', position: [33.2167, 35.7500] },
  { name: 'מסעדה', position: [33.1417, 35.6583] },
  { name: 'ראש פינה', position: [33.0264, 35.5378] },
  { name: 'גוש חלב (גיש)', position: [33.0278, 35.4508] },
  { name: "ע'ג'ר", position: [32.9500, 35.4000] },
  { name: 'עין קנייא', position: [32.8500, 35.3333] },
  { name: 'מטולה', position: [33.2800, 35.5700] },
  { name: 'יסוד המעלה', position: [33.0264, 35.5683] }
].map(mun => {
  const data = municipalityData.find(d => d.רשות === mun.name);
  const value = data ? data['2023'].toLocaleString() : '0';
  return {
    ...mun,
    value,
    color: getColorByPopulation(value),
    historicalData: data
  };
});

function MapController() {
  const map = useMap();
  
  useEffect(() => {
    // Center on Eastern Galilee region
    map.setView([32.95, 35.50], 10);
  }, [map]);
  
  return null;
}

export default function RealMap({ selectedMunicipality }) {
  const markerRefs = useRef({});

  useEffect(() => {
    if (selectedMunicipality && markerRefs.current[selectedMunicipality]) {
      markerRefs.current[selectedMunicipality].openPopup();
    }
  }, [selectedMunicipality]);

  return (
    <div className={styles.container}>
      <MapContainer
        center={[32.95, 35.50]}
        zoom={10}
        style={styles.mapContainer}
        scrollWheelZoom={true}
      >
        <MapController />
        <TileLayer
          attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
        />
        
        {municipalities.map((municipality, idx) => (
          <Marker 
            key={idx} 
            position={municipality.position}
            icon={createColoredIcon(municipality.color)}
            ref={(ref) => {
              if (ref) markerRefs.current[municipality.name] = ref;
            }}
          >
            <Popup>
              <div className={styles.popup} dir="rtl">
                <strong className={styles.popupTitle}>{municipality.name}</strong>
                <span className={styles.popupText}>אוכלוסייה: {municipality.value}</span>
              </div>
            </Popup>
          </Marker>
        ))}
      </MapContainer>
    </div>
  );
}
